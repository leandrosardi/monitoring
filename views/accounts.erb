<%
search_keyword = @login.user.preference('monitoring.agency.accounts.search_keyword', '', params[:search_keyword])
search_premium = @login.user.preference('monitoring.agency.accounts.search_premium', false, params[:search_premium].nil? ? nil : params[:search_premium].to_s == 'true')
selected_ids = @login.user.preference('monitoring.agency.accounts.selected_ids', '', nil)
ids = selected_ids.split(',')

all = "
select 
	a.id,
	a.name as account_name, 
    u.id as id_user,
	u.email as user_email,
    u.name as user_name, 
	a.premium,
	--c.name,
	sum(coalesce(t.stat_sents,0)) as sents,
	sum(coalesce(t.stat_positive_replies,0)) as positive_replies,
	count(distinct s.id) as active_subscriptions,
	-coalesce(b1.credits,0) as leads_credits, 
	-coalesce(b2.credits,0) as emails_credits
	
from account a 
join \"user\" u on (a.id=u.id_account and u.id=a.id_user_to_contact)
left join \"subscription\" s on (a.id=s.id_account and s.active=true)
left join balance b1 on (a.id=b1.id_account and b1.service_code='leads')
left join balance b2 on (a.id=b2.id_account and b2.service_code='deliveries')

left join \"user\" v on a.id=v.id_account
left join eml_campaign c on ( v.id=c.id_user )
left join eml_timeline t on ( c.id=t.id_campaign and t.create_time>'2023-01-01' )

where 1=1
"

all += " 
    and (
        lower(a.name) like '%#{search_keyword.downcase.to_sql}%' or
        lower(u.email) like '%#{search_keyword.downcase.to_sql}%' or
        lower(u.name) like '%#{search_keyword.downcase.to_sql}%' or
        lower(u.phone) like '%#{search_keyword.downcase.to_sql}%' 
    )
" unless search_keyword.empty?

all += "
    and a.premium=true
" unless !search_premium

all += "
group by a.id, a.name, u.id, u.name, u.email, a.create_time, b1.credits, b2.credits, a.premium --, c.name
order by a.create_time desc
"

# TODO: use re-utilizable function here.
page_size = 25
total_rows = DB[all].count
if total_rows>0
  total_pages = (total_rows.to_f/page_size.to_f).ceil
  # if there is a GET parameters `number` on the URL, update the user preference regarding the page number on this screen
  # then, get user preferences regarding the page number on this screen
  page_number = @login.user.preference("emails.addresses.pagination.page", 1, params[:number].nil? ? nil : params[:number].to_i)
  # pagination correction to prevent glitches
  page_number = 1 if page_number < 1
  page_number = total_pages if page_number > total_pages
  # calculate info for showing at the bottom of the table
  from_row = (page_number.to_i-1) * page_size.to_i + 1
  to_row = [page_number*page_size, total_rows].min
else
  total_pages = 1
  page_number = 1
  from_row = 0
  to_row = 0
end

q = "
"+all+"
  LIMIT #{page_size.to_s}
  OFFSET #{((page_number.to_i - 1) * page_size.to_i).to_s}
"
%>

<!-- NavBar -->
<div class="mynavbar mysticky">
	<section class="row-fluid">	
		<div class="span6">
		    <%=nav3("Monotoring", "/monitoring", "Agency", "/monitoring/agency", "Accounts")%>
		</div>
		<div class="span6" style='text-align:right;'>
            <div class="pull-right">
                <form action="/monitoring/agency/accounts" method="get">
                    <div class="span8">
                        <input type='text' class='input-block-level select-all-on-focus' id='search_keyword' name='search_keyword' value='<%=search_keyword.encode_html%>' />
                    </div>
                    <button class="btn btn-blue btn-medium btn-submit" style="margin-left: 2px;" type="submit">
                        <i class='icon-search'></i> Search
                    </button>
                </form>
            </div>    

            <div class='btn-group'>
                <button class='btn btn-blue' id='allow_premium' name='allow_premium' data-rows-group-id='accounts' title='Turn Premium ON'><i class='icon-star'></i></button>
                <button class='btn btn-blue' id='disallow_premium' name='disallow_premium' data-rows-group-id='accounts' title='Turn Premium OFF'><i class='icon-star-empty'></i></button>
                <button class='btn btn-blue' id='add_bonus' name='add_bonus' data-rows-group-id='accounts' data-toggle="modal" id='open_add_bonus_modal' data-target=".add_bonus" title='Add/Remove Bonus Credits'><i class='icon-gift'></i></button>
            </div>

            <div class='btn-group'>
                <a href='/monitoring/agency/accounts?search_premium=<%=search_premium ? "false" : "true"%>' class='btn btn-blue <%=search_premium ? "active" : ""%>' id='premium_only' name='premium_only' title='Show Premium Users Only'><i class='icon-star'></i></a>
            </div>
        </div>
	</section>
</div>

<!-- Single Panel -->
<section class="row-fluid">
	<div class="span12 box">
        <p><b>Records:</b> <%=from_row.to_i.to_label%> to <%=to_row.to_i.to_label%> <b>of</b> <%=total_rows.to_i.to_label%></p>
        <input type='hidden' name='aids' id='aids' value='' />
        <table class="table table-condensed" style="table-layout: fixed; width: 100%;">
            <thead>
                <th style="width:24px;"><input type='checkbox' class='select-all-rows' data-input-id='aids' data-rows-group-id='accounts'></th>
                <th style="width:auto;">Account<br/>Name</th>
                <th style="width:125px;">User<br/>Name</th>
                <th style="width:125px;">User<br/>Email</th>
                <th style="width:48px;">Premium</th>
                <th style="width:55px;text-align:right;">Emails<br/>Sent</th>
                <th style="width:55px;text-align:right;">Replies<br/>Received</th>
                <th style="width:55px;text-align:right;">Active<br/>Subscr.</th>
                <th style="width:55px;text-align:right;">Lead<br/>Credits</th>
                <th style="width:55px;text-align:right;">Email<br/>Credits</th>
                <th style="width:16px;"><!-- access link --></th>
            </thead>
            <tbody>
                <%
                i = 0
                DB[q].all do |row|
                    i += 1
                %>
                <tr>
                    <th><input type='checkbox' class='select-row' data-id='<%=row[:id].to_guid%>' data-uid='<%=row[:id_user].to_guid%>' data-rows-group-id='accounts' <%=ids.include?(row[:id].to_guid) ? 'checked' : ''%> /></th>
                    <td class="fix" title="<%=row[:account_name].to_s.encode_html%>">
                        <%=row[:account_name].to_s.encode_html%><br/>
                        <span style='color:gray;'><%=row[:id].to_s.encode_html%></span>
                    </td>
                    <td class="fix" title="<%=row[:user_name].to_s.encode_html%>">
                        <%=row[:user_name].to_s.encode_html%>
                    </td>
                    <td class="fix" title="<%=row[:user_email].to_s.encode_html%>">
                        <a href='mailto:<%=row[:user_email].to_s.encode_html%>'><%=row[:user_email].to_s.encode_html%></a>
                    </td>
                    <td class="fix" title="<%=row[:premium].to_s.encode_html%>">
                        <%=row[:premium] ? '<i class="icon-ok" style="color:blue"></i>' : '<i class="icon-remove" style="color:red"></i>'%>
                    </td>


                    <td class="fix" title="<%=row[:sents].to_i.to_label.encode_html%>" style="text-align:right;">
                        <%=row[:sents].to_i.to_label%>
                    </td>
                    <td class="fix" title="<%=row[:positive_replies].to_i.to_label.encode_html%>" style="text-align:right;">
                        <%=row[:positive_replies].to_i.to_label%><br/>
                        <%
                        # canculate the percentage of positive replies, with 4 decimals
                        percent = 0
                        if row[:sents].to_i > 0
                            percent = (row[:positive_replies].to_f / row[:sents].to_f) * 100
                            percent = percent.round(4)
                        end
                        %>
                        <span style='color:gray;'><%=percent.to_s.encode_html%>%</span>

                    </td>
                    <td class="fix" title="<%=row[:active_subscriptions].to_i.to_label.encode_html%>" style="text-align:right;">
                        <%=row[:active_subscriptions].to_i.to_label%>
                    </td>
                    <td class="fix" title="<%=row[:leads_credits].to_i.to_label.encode_html%>" style="text-align:right;">
                        <%=row[:leads_credits].to_i.to_label%>
                    </td>
                    <td class="fix" title="<%=row[:emails_credits].to_i.to_label.encode_html%>" style="text-align:right;">
                        <%=row[:emails_credits].to_i.to_label%>
                    </td>

                    <td class="fix" title="Account Access Link. Paste it into another browser." style='text-align:center;'>
                        <button class='btn btn-link secret_login' name='secret_login'><i class="icon-copy"></i></button>
                    </td>
                </tr>
                <%
                end

                if i==0
                %>
                <tr>
                    <td colspan="11" class="fix" align='center' style='text-align:center;'>
                        No users found.
                    </td>
                <tr>
                <%
                end
                %>
            </tbody>
        </table>
        <div class="pagination"></div>
    </div>
</section>

<!-- Modal Exports Leads-->
<div class="modal fade add_bonus" >
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h3>Add Bonus</h3>
    </div>
    <div class="modal-body">
        <div>
            <form action="/monitoring/agency/filter_add_bonus" method="get" id='add_bonus_form' name='add_bonus_form'>
                <input type="hidden" id="selected_ids" name='selected_ids' class='selected-ids' value='<%=selected_ids.to_s%>'>
                <label>
                    Lead Credits
                    <input type="number" class='select-all-on-focus' id="lead_credits" name="lead_credits" placeholder="Write a number here." value='0' />
                </label>
                <label>
                    Email Credits
                    <input type="number" class='select-all-on-focus' id="email_credits" name="email_credits" placeholder="Write a number here." value='0' />
                </label>
            </form>
        </div>    
    </div>
    <div class="modal-footer">
        <a href="#" data-dismiss="modal" class="btn btn-close">Close</a>
        <button type="submit" id="add_bonus_button" name="add_bonus_button" class="btn btn-blue">Submit</button>
    </div>
</div>

<script>
    $(document).ready(function() {
        selectRowsJs.init();
        drawPagination($(".pagination"), <%=page_number%>, <%=total_pages%>);

        $('#allow_premium').click(function() {
            window.location.href = '/monitoring/agency/filter_allow_premium?aids=' + $('#aids').val();
        });

        $('#disallow_premium').click(function() {
            window.location = '/monitoring/agency/filter_disallow_premium?aids=' + $('#aids').val();
        });

        $('.secret_login').click(function() {
            var uid = $(this).closest('tr').find('.select-row').data('uid');
            secret_login_url = '<%=CS_HOME_WEBSITE%>/monitoring/filter_secret_login?lid=<%=@login.id%>&uid=' + uid;
            navigator.clipboard.writeText(secret_login_url);

            // get the icon inside this button
            var icon = $(this).find('i');
            // change the icon to a checkmark
            icon.removeClass('icon-copy');
            icon.addClass('icon-ok');
            // wait 1 second to rollback the icon to icon-copy
            setTimeout(function() {
                icon.removeClass('icon-ok');
                icon.addClass('icon-copy');
            }, 1000);
        });

        // submit form #edit_addresses_form when button #edit_addresses_button is clicked
        $('#add_bonus_button').click(function() {
            $('#add_bonus_form').find('#selected_ids').val($('#aids').val());
            $('#add_bonus_form').submit();
        });

        // hide modals when show the page
        // use the .hide() method, in order to don't get the modal blocking other elements behind them.
        $('.add_bonus').hide();
    });
</script>